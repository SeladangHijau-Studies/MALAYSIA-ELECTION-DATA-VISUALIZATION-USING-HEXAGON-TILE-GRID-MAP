<!-- todo = buat json file dynamic -->

<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
        <title>MALAYSIA ELECTION DATA VISUALIZATION USING HEXAGON TILE-GRID MAP</title>

        <link rel="stylesheet" href="../lib/css/bootstrap.min.css" />
        <link rel="stylesheet" href="../lib/css/bootstrap-theme.min.css" />
        <style>
            * {
                margin: 0 auto;
            }

            ul {
                list-style: none;
            }

            .vcenter {
                display: inline-block;
                vertical-align: middle;
                float: none;
            }

            .tooltip {
                line-height: 1;
                font-weight: bold;
                padding: 12px;
                background: rgba(0, 0, 0, 0.8);
                border-radius: 5px;
                visibility: hidden;
                position: absolute;
                z-index: 10;
                font-weight: bold;
                color: white;
            }

            .popup {
                border-radius: 10px;
                color: white;
                background-color: rgba(0, 0, 0, .8);
            }
            .popup-content {
                visibility: hidden;
            }

            .state-label {
                font-weight: bold;
                color: white;
            }

            .title {
                font-weight: bold;
                text-shadow:
                    -1px 0 grey,
                    0 1px grey,
                    1px 0 grey,
                    0 -1px grey;
            }

            #chart-map {
                overflow: hidden;
                border: 1px solid black;
                background-color: rgba(0, 0, 0, .05);
            }
            
            #title-malay { color: blue; }
            #title-chinese { color: red; }
            #title-indian { color: purple; }
            #title-sabah { color: green; }
            #title-sarawak { color: magenta; }
            #title-other { color: grey; }

            #chart-election,
            #chart-demography {
                background-color: grey;
            }
        </style>
    </head>

    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-offset-3 col-md-6">
                    <h3><b>MALAYSIA ELECTION DATA VISUALIZATION (GE-14)</b></h3>
                    <ul><li><h4>USING HEXAGON TILE GRID MAP</h4></li></ul>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="row">
                        <!-- map -->
                        <div class="col-md-6">
                            <div id="chart-map"></div>
                        </div>

                        <!-- popup -->
                        <div class="col-md-6 popup">
                            <div class="popup-content">
                                <!-- title -->
                                <div class="row">
                                    <div class="col-md-offset-1 col-md-10">
                                        <h3>
                                            <b>[<span id="parliament-code"></span>] </b>
                                            <u><span id="parliament-name"></span></u>
                                        </h3>
                                    </div>
                                </div>

                                <!-- election data -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <h4><b>ELECTION RESULT</b></h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-5">
                                        <div id="chart-election"></div>
                                    </div>
                                    <div class="col-md-7">
                                        <h4>
                                            <b>WINNING PARTY: </b>
                                            <span id="winning-party"></span>
                                        </h4>
                                        <h4>
                                            <b>WINNING CANDIDATE: </b>
                                            <span id="winning-candidate"></span>
                                        </h4>
                                        <h5><u><b>TOTAL VOTES:</b></u></h5>
                                        <ul>
                                            <li>
                                                <b>BN: [<span id="vote-BN"></span> votes]</b><br />
                                                <ul><li><u><span id="candidate-BN"></span></u></li></ul>
                                            </li>
                                            <li>
                                                <b>PH: [<span id="vote-PH"></span> votes]</b><br />
                                                <ul><li><u><span id="candidate-PH"></span></u></li></ul>
                                            </li>
                                            <li>
                                                <b>PAS: [<span id="vote-PAS"></span> votes]</b><br />
                                                <ul><li><u><span id="candidate-PAS"></span></u></li></ul>
                                            </li>
                                            <li>
                                                <b>Others: [<span id="vote-OTH"></span> votes]</b><br />
                                                <ul><li><u><span id="candidate-OTH"></span></u></li></ul>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- demographic data -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <h4><b>DEMOGRAPHICS</b></h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-5">
                                        <div id="chart-demography"></div>
                                    </div>
                                    <div class="col-md-7">
                                        <ul>
                                            <li>
                                                <span class="title" id="title-malay">MALAY: </span>
                                                <span id="race-malay"></span>%
                                            </li>
                                            <li>
                                                <span class="title" id="title-chinese">CHINESE: </span>
                                                <span id="race-chinese"></span>%
                                            </li>
                                            <li>
                                                <span class="title" id="title-indian">INDIAN: </span>
                                                <span id="race-indian"></span>%
                                            </li>
                                            <li>
                                                <span class="title" id="title-other">OTHERS: </span>
                                                <span id="race-other"></span>%
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="../lib/js/jquery-3.3.1.min.js"></script>
        <script src="../lib/js/d3.min.js"></script>
        <script src="../lib/js/d3-hexbin.min.js"></script>
        <script src="../lib/js/bootstrap.min.js"></script>
        <script>
            d3.json("../json/setting.json", function(setting) {
                // initialize settings
                var level = 1
                    // attr for zooming
                    scale = 1.0,
                    zoomScale = 2.0;
                var zoom = d3.behavior.zoom()
                    .scale(scale)
                    .scaleExtent([1, 5])
                    .on("zoom", zoomed);
                var svg = d3.select("#chart-map").append("svg")
                    .attr("width", setting.width)
                    .attr("height", setting.height)
                    .call(zoom);
                var hexbin = d3.hexbin()
                    .radius(setting.hexagon_radius);
                var tooltip = d3.select("body")
                    .append("div")
                        .attr("class", "tooltip");
                var selectedState = null;

                function zoomed() {
                    var translateX = d3.event.translate[0];
                    var translateY = d3.event.translate[1];
                    var xScale = d3.event.scale;

                    svg.attr("transform", "translate(" + translateX + "," + translateY + ")scale(" + xScale + ")");
                }

                function loadEthnicDemographyChart(stateId) {
                    d3.json("../json/demography.json", function(demography) {
                        var w = 200,
                            h = 200,
                            r = 100,
                            color = ["red", "green", "blue", "yellow"];
                        var arc = d3.svg.arc()
                            .outerRadius(r);
                        var pie = d3.layout.pie()
                            .value(function(d) { return d.value; });

                        var ethnicDemography;
                        for(var x=0 ; x<demography.length ; x++) {
                            if(demography[x].state_id == stateId) {
                                ethnicDemography = [
                                    {"label": "Malay", "value": demography[x].demography.ethnic.malay},
                                    {"label": "Indian", "value": demography[x].demography.ethnic.indian},
                                    {"label": "Chinese", "value": demography[x].demography.ethnic.chinese},
                                    {"label": "Others", "value": demography[x].demography.ethnic.others}
                                ];

                                break;
                            }
                        }
                        
                        var ethnicSVG = d3.select("#chart-demography-ethnic").append("svg")
                            .attr("width", w)
                            .attr("height", h)
                            .data([ethnicDemography])
                            .append("g")
                                .attr("transform", "translate(" + (w/2) + "," + (h/2) + ")");
                        var arcs = ethnicSVG.selectAll(".slice")
                            .data(pie)
                            .enter().append("g")
                                .attr("class", "slice");
        
                        arcs.append("path")
                            .attr("fill", function(d, i) { return color[i]; })
                            .attr("d", arc);

                        arcs.append("text")
                            .text(function(d, i) { return ethnicDemography[i].label; })
                            .attr("transform", function(d, i) {
                                d.innerRadius = 0;
                                d.outerRadius = r;

                                return "translate(" + arc.centroid(d) + ")";
                            })
                            .attr("text-anchor", "middle")
                            .style("font-weight", "bold")
                            .style("color", "white");
                    });
                }

                d3.json("../json/parliament.json", function(parliamentList) {
                    // init coordinate data from json
                    var parliamentCoordinateList = [];
                    for(var x=0 ; x<parliamentList.length ; x++) {
                        var tempCoordinate = [];
                        for(var y=0 ; y<parliamentList[x].parliament.length ; y++) {
                            var xyCoor = [];

                            xyCoor.push(parliamentList[x].parliament[y].coordinate.x);
                            xyCoor.push(parliamentList[x].parliament[y].coordinate.y);
                            tempCoordinate.push(xyCoor);
                        }

                        parliamentCoordinateList.push(tempCoordinate);
                    }

                    close_popup = function() {
                        level = 1;

                        d3.select(".popup-content").style("visibility", "hidden");
                        d3.select("#btn-popup-close").style("visibility", "hidden");
                        d3.selectAll("g")
                            .style("opacity", 1);
                        d3.select(".system-title")
                            .style("visibility", "visible");
                        d3.selectAll(".state-label")
                            .style("visibility", "visible");
                        selectedState.selectAll(".parliament")
                            .attr("class", "parliament");

                        for(var x=0 ; x<setting.state_id.length ; x++)
                            if(setting.state_id[x] == selectedState.attr("id"))
                                selectedState.selectAll(".parliament")
                                    .style("stroke", function() {
                                        return setting.colors.states[x];
                                    })
                                    .style("fill", function() {
                                        return setting.colors.states[x];
                                    });
                    }

                    d3.json("../json/election.json", function(election) {
                        var g = svg.selectAll("g")
                            .data(parliamentList);

                        // populate data visualization                        
                        g.enter().append("g")
                            .attr("id", function(d, i) {
                                return setting.state_id[i];
                            })
                            .attr("class", "state")
                            .style('fill', function(d, i) {
                                return setting.colors.states[i];
                            })
                            .style('stroke', function(d, i) {
                                return setting.colors.states[i];
                            })
                            .on("mousemove", function() {
                                tooltip.style("top", (event.pageY - 10)+"px")
                                    .style("left",(event.pageX + 20)+"px");
                            })
                            .on("mouseout", function() {
                                tooltip.transition().duration(200)		
                                    .style("opacity", 0);
                            } )
                            .on("click", function(d, i, j) {
                                if(level == 1) {
                                    level = 2;
                                    selectedState = d3.select(this);

                                    tooltip.transition().duration(200)		
                                        .style("opacity", 0);
                                    d3.selectAll(".state-label")
                                        .style("visibility", "hidden");
                                    d3.select("#" + selectedState.attr("id") + "-label")
                                        .style("visibility", "visible");
                                    d3.selectAll("g")
                                        .style("opacity", ".2");
                                    d3.select(this)
                                        .style("opacity", 1)
                                        .selectAll(".parliament")
                                        .attr("class", "parliament active")
                                        .style("stroke", "white")
                                        .style("fill", function(d, j) {
                                            var winner = election[i].result[j].winner.party;

                                            switch(winner) {
                                                case "BN":
                                                    return setting.colors.parties.BN;
                                                    break;
                                                case "PH":
                                                    return setting.colors.parties.PH;
                                                    break;
                                                case "PAS":
                                                    return setting.colors.parties.PAS;
                                                    break;
                                                case "OTH":
                                                    return setting.colors.parties.OTH;
                                                    break;
                                            }
                                        });
                                }
                            })
                            .selectAll(".parliament")
                            .data(function(d, i) {
                                return hexbin(parliamentCoordinateList[i]);
                            })
                            .enter().append("path")
                                .attr("class", "parliament")
                                .attr("id", function(d, i, j) {
                                    return parliamentList[j].parliament[i].parliament_code;
                                })
                                .attr("d", function(d) {
                                    return "M" + (d.x + setting.padding)
                                        + ","
                                        + (d.y + setting.padding) + hexbin.hexagon();
                                })
                                .on("mouseover", function(d, i, j) {
                                    var thisHex = d3.select(this).attr("class");

                                    if((level == 2) && (thisHex == "parliament active")) {
                                        tooltip.transition().duration(200)
                                            .text(parliamentList[j].parliament[i].parliament_code
                                                + " : "
                                                + parliamentList[j].parliament[i].parliament_name)
                                            .style("opacity", .9)
                                            .style("visibility", "visible");
                                    }
                                })
                                .on("click", function(d, i, j) {
                                    var thisHex = d3.select(this).attr("class");

                                    if((level == 2) && (thisHex == "parliament active")) {
                                        d3.json("../json/demography.json", function(demography) {
                                            var parliamentResult = election[j].result[i];
                                            var demographicResult = demography[j].demography[i];
                                            var parliamentName = parliamentList[j].parliament[i].parliament_name;

                                            d3.select(".popup-content").style("visibility", "visible");
                                            d3.select("#btn-popup-close").style("visibility", "visible");

                                            d3.select("#parliament-code").text(parliamentResult.parliament_code);
                                            d3.select("#parliament-name").text(parliamentName);
                                            d3.select("#winning-party").text(parliamentResult.winner.party);
                                            d3.select("#winning-candidate").text(parliamentResult.winner.candidate);
                                            d3.select("#vote-BN").text(parliamentResult.vote.BN);
                                            d3.select("#vote-PH").text(parliamentResult.vote.PH);
                                            d3.select("#vote-PAS").text(parliamentResult.vote.PAS);
                                            d3.select("#vote-OTH").text(parliamentResult.vote.OTH);
                                            d3.select("#candidate-BN").text(parliamentResult.candidate.BN);
                                            d3.select("#candidate-PH").text(parliamentResult.candidate.PH);
                                            d3.select("#candidate-PAS").text(parliamentResult.candidate.PAS);
                                            d3.select("#candidate-OTH").text(parliamentResult.candidate.OTH);
                                            d3.select("#race-malay").text(demographicResult.race.malay);
                                            d3.select("#race-chinese").text(demographicResult.race.chinese);
                                            d3.select("#race-indian").text(demographicResult.race.indian);
                                            d3.select("#race-other").text(demographicResult.race.others);
                                        });
                                    }
                                });

                            // initialize label
                            g.enter().append("text")
                                .attr("class", "state-label")
                                .attr("id", function(d, i) { return setting.state_id[i] + "-label"; })
                                .style("font-weight", "bold")
                                .style("fill", "black")
                                .style("cursor", "default")
                                .style("pointer-events", "none")
                                .style("text-shadow", function(d, i) { // initialize lable outline
                                    return "-1px -1px 0 "
                                        + setting.colors.states[i] + ", 1px -1px 0 "
                                        + setting.colors.states[i] + ", -1px 1px 0 "
                                        + setting.colors.states[i] + ", 1px 1px 0 "
                                        + setting.colors.states[i];
                                })
                                .attr("x", function(d, i) {
                                    var bbox = d3.select("#" + setting.state_id[i]).node().getBBox();

                                    switch(setting.state_id[i]) {
                                        case "perlis":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 25);
                                            break;
                                        case "kedah":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 20);
                                            break;
                                        case "pulau-pinang":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 55);
                                            break;
                                        case "perak":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 30);
                                            break;
                                        case "kelantan":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 35);
                                            break;
                                        case "terengganu":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 50);
                                            break;
                                        case "kuala-lumpur":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 80);
                                            break;
                                        case "selangor":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 70);
                                            break;
                                        case "putrajaya":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 70);
                                            break;
                                        case "pahang":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 20);
                                            break;
                                        case "negeri-sembilan":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 100);
                                            break;
                                        case "melaka":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 30);
                                            break;
                                        case "johor":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 20);
                                            break;
                                        case "labuan":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 50);
                                            break;
                                        case "sabah":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 30);
                                            break;
                                        case "sarawak":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 5);
                                            break;
                                        default:
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2);
                                            break;
                                    }
                                })
                                .attr("y",  function(d, i) {
                                    var bbox = d3.select("#" + setting.state_id[i]).node().getBBox();
                                    
                                    switch(setting.state_id[i]) {
                                        case "perlis":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "pulau-pinang":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "perak":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 15);
                                            break;
                                        case "kuala-lumpur":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 10);
                                            break;
                                        case "selangor":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 - 30);
                                            break;
                                        case "putrajaya":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "pahang":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "negeri-sembilan":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "melaka":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "labuan":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "sabah":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        default:
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2);
                                            break;
                                    }
                                })
                                .text(function(d) { return d.state_name; });

                            // popup close button
                            d3.select("#chart-map")
                                .append("div")
                                    .attr("class", "row")
                                    .attr("id", "btn-popup-close")
                                    .style("visibility", "hidden")
                                    .append("div")
                                        .attr("class", "col-md-offset-4 col-md-4")
                                        .append("button")
                                            .text("Back")
                                            .attr("class", "btn btn-primary")
                                            .attr("onclick", "close_popup()");
                    });
                });
            });
        </script>
    </body>
</html>
