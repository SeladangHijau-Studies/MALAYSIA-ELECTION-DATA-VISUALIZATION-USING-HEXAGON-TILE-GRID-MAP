<!-- todo = buat json file dynamic -->

<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
        <title>MALAYSIA ELECTION DATA VISUALIZATION USING HEXAGON TILE-GRID MAP</title>

        <link rel="stylesheet" href="lib/css/bootstrap.min.css" />
        <link rel="stylesheet" href="lib/css/bootstrap-theme.min.css" />
        <style>
            .tooltip {
                line-height: 1;
                font-weight: bold;
                padding: 12px;
                background: rgba(0, 0, 0, 0.8);
                border-radius: 5px;
                visibility: hidden;
                position: absolute;
                z-index: 10;
                font-weight: bold;
                color: white;
            }

            .popup {
                visibility: hidden;

                opacity: .8;
                z-index: 20;
                position: absolute;

                padding: 5px;
                top: 0px;
                left: 0px;
                width: 100%;
                height: 100%;

                border-radius: 10px;

                color: white;
                background-color: black;
            }
        </style>
    </head>

    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-offset-2 col-md-6">
                    <h3>MALAYSIA ELECTION DATA VISUALIZATION</h3>
                    <div class="row">
                        <div class="col-md-offset-1 col-md-4">
                            <h4>PRU-13</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-offset-2 col-md-8">
                    <div id="chart"></div>
                </div>
            </div>
        </div>

        <script src="lib/js/jquery-3.3.1.min.js"></script>
        <script src="lib/js/d3.min.js"></script>
        <script src="lib/js/d3-hexbin.min.js"></script>
        <script src="lib/js/bootstrap.min.js"></script>
        <script>
            d3.json("json/setting.json", function(setting) {
                // initialize settings
                var level = 1;
                var svg = d3.select("#chart").append("svg")
                    .attr("width", setting.width)
                    .attr("height", setting.height);
                var hexbin = d3.hexbin()
                    .radius(setting.hexagon_radius);
                var tooltip = d3.select("body")
                    .append("div")
                        .attr("class", "tooltip");
                var popup = d3.select("body")
                    .append("div")
                        .attr("class", "popup");

                close_popup = function() {
                    level = 1;

                    popup.style("visibility", "hidden");
                    d3.selectAll("g")
                        .style("opacity", 1);
                }

                d3.json("json/parliament.json", function(parliamentList) {
                    // init coordinate data from json
                    var parliamentCoordinateList = [];
                    for(var x=0 ; x<parliamentList.length ; x++) {
                        var tempCoordinate = [];
                        for(var y=0 ; y<parliamentList[x].parliament.length ; y++) {
                            var xyCoor = [];

                            xyCoor.push(parliamentList[x].parliament[y].coordinate.x);
                            xyCoor.push(parliamentList[x].parliament[y].coordinate.y);
                            tempCoordinate.push(xyCoor);
                        }

                        parliamentCoordinateList.push(tempCoordinate);
                    }

                    d3.json("json/election.json", function(election) {
                        // populate data visualization
                        svg.selectAll("g")
                            .data(parliamentList)
                            .enter().append("g")
                                .attr("id", function(d) {
                                    return d.state_name;
                                })
                                .style('fill', function(d, i) {
                                    return setting.colors.states[i];
                                })
                                .style('stroke', function(d, i) {
                                    return setting.colors.states[i];
                                })
                                .on("mouseover", function(d) {
                                    if(level == 1) {
                                        tooltip.text(d.state_name)
                                            .transition().duration(200)
                                            .style("opacity", .9)
                                            .style("visibility", "visible");
                                    }
                                })
                                .on("mousemove", function() {
                                    tooltip
                                        .style("top", (event.pageY - 10)+"px")
                                        .style("left",(event.pageX + 20)+"px");
                                })
                                .on("mouseout", function() {
                                    tooltip.transition().duration(200)		
                                        .style("opacity", 0);
                                } )
                                .on("click", function(d, i) {
                                    if(level == 1) {
                                        level = 2;

                                        tooltip.transition().duration(200)		
                                            .style("opacity", 0);
                                        
                                        $(document).ready(function() {
                                            $.get("popup-state.html", function(htmlResult) {
                                                popup.html(htmlResult)
                                                    .style("visibility", "visible")
                                                    .style("width", "50%")
                                                    .style("height", "50%")
                                                    .style("top", "10px")
                                                    .style("left", "10px");
                                            }, "html");
                                        });

                                        d3.selectAll("g")
                                            .style("opacity", .5);
                                        d3.select(this)
                                            .style("opacity", 1)
                                            .style("stroke", "white");
                                    }
                                })
                                .selectAll(".parliament")
                                .data(function(d, i) {
                                    return hexbin(parliamentCoordinateList[i]);
                                })
                                .enter().append("path")
                                    .attr("class", "parliament")
                                    .attr("id", function(d, i, j) {
                                        return parliamentList[j].parliament[i].parliament_code;
                                    })
                                    .attr("d", function(d) {
                                        return "M" + (d.x + setting.padding)
                                            + ","
                                            + (d.y + setting.padding) + hexbin.hexagon();
                                    })
                                    .on("mouseover", function(d, i, j) {
                                        if(level == 2) {
                                            tooltip.transition().duration(200)
                                                .text(parliamentList[j].parliament[i].parliament_code
                                                    + " : "
                                                    + parliamentList[j].parliament[i].parliament_name)
                                                .style("opacity", .9)
                                                .style("visibility", "visible");
                                        }
                                    })
                                    .on("mousemove", function(event) {
                                        tooltip
                                            .style("top", (event.pageY - 10)+"px")
                                            .style("left",(event.pageX + 20)+"px");
                                    })
                                    .on("mouseout", function() {
                                        tooltip.transition().duration(200)		
                                            .style("opacity", 0);
                                    })
                                    .on("click", function(d, i, j) {
                                        if(level == 2) {
                                            var parliamentResult = election[j].result[i];
                                            var parliamentName = parliamentList[j].parliament[i].parliament_name;

                                            $(document).ready(function() {
                                                $.get("popup-parliament.html", function(htmlResult) {
                                                    popup.html(htmlResult)
                                                        .style("visibility", "visible")
                                                        .style("width", "50%")
                                                        .style("height", "50%")
                                                        .style("top", "10px")
                                                        .style("left", "10px");
                                                    
                                                    d3.select("#parliament-code").text(parliamentResult.parliament_code);
                                                    d3.select("#parliament-name").text(parliamentName);
                                                    d3.select("#winning-party").text(parliamentResult.winner.party);
                                                    d3.select("#winning-candidate").text(parliamentResult.winner.candidate);
                                                    d3.select("#total-voter").text(parliamentResult.vote.voter_total);
                                                    d3.select("#total-vote-bn").text(parliamentResult.vote.BN);
                                                    d3.select("#total-vote-pas").text(parliamentResult.vote.PAS);
                                                    d3.select("#total-vote-pkr").text(parliamentResult.vote.PKR);
                                                    d3.select("#total-vote-dap").text(parliamentResult.vote.DAP);
                                                    d3.select("#total-vote-oth").text(parliamentResult.vote.OTH);
                                                }, "html");
                                            });
                                        }
                                    });
                    });
                });
            });
        </script>
    </body>
</html>
