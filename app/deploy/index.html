<!-- todo = buat json file dynamic -->

<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
        <title>MALAYSIA ELECTION DATA VISUALIZATION USING HEXAGON TILE-GRID MAP</title>

        <link rel="stylesheet" href="lib/css/bootstrap.min.css" />
        <link rel="stylesheet" href="lib/css/bootstrap-theme.min.css" />
        <style>
            .tooltip {
                line-height: 1;
                font-weight: bold;
                padding: 12px;
                background: rgba(0, 0, 0, 0.8);
                border-radius: 5px;
                visibility: hidden;
                position: absolute;
                z-index: 10;
                font-weight: bold;
                color: white;
            }

            .popup {
                visibility: hidden;
                
                z-index: 20;
                position: absolute;

                padding: 5px;
                top: 0px;
                left: 0px;
                width: 100%;
                height: 100%;

                border-radius: 10px;

                color: white;
                background-color: rgba(0, 0, 0, .9);
            }

            .state-label {
                font-weight: bold;
                box-shadow: 0 0 0 100px black;
            }

            #chart {
                overflow: hidden;
                border: 1px solid black;
            }
        </style>
    </head>

    <body>
        <div class="container-fluid">
            <div class="row system-title">
                <div class="col-md-offset-2 col-md-6">
                    <h3><b>MALAYSIA ELECTION DATA VISUALIZATION</b></h3>
                    <div class="row">
                        <div class="col-md-offset-1 col-md-4">
                            <h4><u>GE-14</u></h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-offset-2 col-md-7">
                    <div id="chart"></div>
                </div>
            </div>
        </div>

        <script src="lib/js/jquery-3.3.1.min.js"></script>
        <script src="lib/js/d3.min.js"></script>
        <script src="lib/js/d3-hexbin.min.js"></script>
        <script src="lib/js/bootstrap.min.js"></script>
        <script>
            d3.json("json/setting.json", function(setting) {
                // initialize settings
                var level = 1
                    // attr for zooming
                    scale = 1.0,
                    zoomScale = 2.0;
                var zoom = d3.behavior.zoom()
                    .scale(scale)
                    .scaleExtent([1, 5])
                    .on("zoom", zoomed);
                var svg = d3.select("#chart").append("svg")
                    .attr("width", setting.width)
                    .attr("height", setting.height)
                    .call(zoom);
                var hexbin = d3.hexbin()
                    .radius(setting.hexagon_radius);
                var tooltip = d3.select("body")
                    .append("div")
                        .attr("class", "tooltip");
                var popup = d3.select("body")
                    .append("div")
                        .attr("class", "popup");
                var selectedState = null;

                function zoomed() {
                    var translateX = d3.event.translate[0];
                    var translateY = d3.event.translate[1];
                    var xScale = d3.event.scale;

                    svg.attr("transform", "translate(" + translateX + "," + translateY + ")scale(" + xScale + ")");
                }

                function loadEthnicDemographyChart(stateId) {
                    d3.json("json/demography.json", function(demography) {
                        var w = 200,
                            h = 200,
                            r = 100,
                            color = ["red", "green", "blue", "yellow"];
                        var arc = d3.svg.arc()
                            .outerRadius(r);
                        var pie = d3.layout.pie()
                            .value(function(d) { return d.value; });

                        var ethnicDemography;
                        for(var x=0 ; x<demography.length ; x++) {
                            if(demography[x].state_id == stateId) {
                                ethnicDemography = [
                                    {"label": "Malay", "value": demography[x].demography.ethnic.malay},
                                    {"label": "Indian", "value": demography[x].demography.ethnic.indian},
                                    {"label": "Chinese", "value": demography[x].demography.ethnic.chinese},
                                    {"label": "Others", "value": demography[x].demography.ethnic.others}
                                ];

                                break;
                            }
                        }
                        
                        var ethnicSVG = d3.select("#chart-demography-ethnic").append("svg")
                            .attr("width", w)
                            .attr("height", h)
                            .data([ethnicDemography])
                            .append("g")
                                .attr("transform", "translate(" + (w/2) + "," + (h/2) + ")");
                        var arcs = ethnicSVG.selectAll(".slice")
                            .data(pie)
                            .enter().append("g")
                                .attr("class", "slice");
        
                        arcs.append("path")
                            .attr("fill", function(d, i) { return color[i]; })
                            .attr("d", arc);

                        arcs.append("text")
                            .text(function(d, i) { return ethnicDemography[i].label; })
                            .attr("transform", function(d, i) {
                                d.innerRadius = 0;
                                d.outerRadius = r;

                                return "translate(" + arc.centroid(d) + ")";
                            })
                            .attr("text-anchor", "middle")
                            .style("font-weight", "bold")
                            .style("color", "white");
                    });
                }

                function loadRaceDemographyChart(stateId) {
                    d3.json("json/demography.json", function(demography) {
                        var w = 300,
                            h = 300,
                            r = 100,
                            color = d3.scale.category20c();
                        var arc = d3.svg.arc()
                            .outerRadius(r);
                        var pie = d3.layout.pie()
                            .value(function(d) { return d.value; });

                        var genderDemography;
                        for(var x=0 ; x<demography.length ; x++) {
                            if(demography[x].state_id == stateId) {
                                genderDemography = [
                                    {"label": "Male", "value": demography[x].demography.gender.male},
                                    {"label": "Female", "value": demography[x].demography.gender.female}
                                ];
                                
                                break;
                            }
                        }
                    });
                }

                d3.json("json/parliament.json", function(parliamentList) {
                    // init coordinate data from json
                    var parliamentCoordinateList = [];
                    for(var x=0 ; x<parliamentList.length ; x++) {
                        var tempCoordinate = [];
                        for(var y=0 ; y<parliamentList[x].parliament.length ; y++) {
                            var xyCoor = [];

                            xyCoor.push(parliamentList[x].parliament[y].coordinate.x);
                            xyCoor.push(parliamentList[x].parliament[y].coordinate.y);
                            tempCoordinate.push(xyCoor);
                        }

                        parliamentCoordinateList.push(tempCoordinate);
                    }

                    close_popup = function() {
                        level = 1;

                        popup.style("visibility", "hidden");
                        d3.selectAll("g")
                            .style("opacity", 1);
                        d3.select(".system-title")
                            .style("visibility", "visible");
                        d3.selectAll(".state-label")
                            .style("visibility", "visible");

                        for(var x=0 ; x<setting.state_id.length ; x++)
                            if(setting.state_id[x] == selectedState.attr("id"))
                                selectedState.selectAll(".parliament")
                                    .style("stroke", function() {
                                        return setting.colors.states[x];
                                    })
                                    .style("fill", function() {
                                        return setting.colors.states[x];
                                    });
                    }

                    d3.json("json/election.json", function(election) {
                        var g = svg.selectAll("g")
                            .data(parliamentList);

                        // populate data visualization                        
                        g.enter().append("g")
                            .attr("id", function(d, i) {
                                return setting.state_id[i];
                            })
                            .attr("class", "state")
                            .style('fill', function(d, i) {
                                return setting.colors.states[i];
                            })
                            .style('stroke', function(d, i) {
                                return setting.colors.states[i];
                            })
                            .on("mousemove", function() {
                                tooltip.style("top", (event.pageY - 10)+"px")
                                    .style("left",(event.pageX + 20)+"px");
                            })
                            .on("mouseout", function() {
                                tooltip.transition().duration(200)		
                                    .style("opacity", 0);
                            } )
                            .on("click", function(d, i, j) {
                                if(level == 1) {
                                    level = 2;
                                    selectedState = d3.select(this);

                                    // state demography chart
                                    $(document).ready(function() {
                                        $.get("popup-state.html", function(htmlResult) {
                                            popup.html(htmlResult)
                                                .style("visibility", "visible")
                                                .style("width", "50%")
                                                .style("height", "50%")
                                                .style("top", "10px")
                                                .style("left", "10px");

                                            d3.select("#state-name").text(parliamentList[i].state_name);
                                            
                                            // demography chart
                                            loadEthnicDemographyChart(selectedState.attr("id"));
                                            
                                        }, "html");
                                    });

                                    tooltip.transition().duration(200)		
                                        .style("opacity", 0);
                                    d3.select(".system-title")
                                        .style("visibility", "hidden");
                                    d3.selectAll(".state-label")
                                        .style("visibility", "hidden");
                                    d3.selectAll("g")
                                        .style("opacity", ".2");
                                    d3.select(this)
                                        .style("opacity", 1)
                                        .selectAll(".parliament")
                                        .attr("class", "parliament active")
                                        .style("stroke", "white")
                                        .style("fill", function(d, j) {
                                            var winner = election[i].result[j].winner.party;

                                            switch(winner) {
                                                case "BN":
                                                    return setting.colors.parties.BN;
                                                    break;
                                                case "PH":
                                                    return setting.colors.parties.PH;
                                                    break;
                                                case "PAS":
                                                    return setting.colors.parties.PAS;
                                                    break;
                                                case "OTH":
                                                    return setting.colors.parties.OTH;
                                                    break;
                                            }
                                        });
                                }
                            })
                            .selectAll(".parliament")
                            .data(function(d, i) {
                                return hexbin(parliamentCoordinateList[i]);
                            })
                            .enter().append("path")
                                .attr("class", "parliament")
                                .attr("id", function(d, i, j) {
                                    return parliamentList[j].parliament[i].parliament_code;
                                })
                                .attr("d", function(d) {
                                    return "M" + (d.x + setting.padding)
                                        + ","
                                        + (d.y + setting.padding) + hexbin.hexagon();
                                })
                                .on("mouseover", function(d, i, j) {
                                    var thisHex = d3.select(this).attr("class");

                                    if((level == 2) && (thisHex == "parliament active")) {
                                        tooltip.transition().duration(200)
                                            .text(parliamentList[j].parliament[i].parliament_code
                                                + " : "
                                                + parliamentList[j].parliament[i].parliament_name)
                                            .style("opacity", .9)
                                            .style("visibility", "visible");
                                    }
                                })
                                .on("click", function(d, i, j) {
                                    var thisHex = d3.select(this).attr("class");

                                    if((level == 2) && (thisHex == "parliament active")) {
                                        var parliamentResult = election[j].result[i];
                                        var parliamentName = parliamentList[j].parliament[i].parliament_name;

                                        $(document).ready(function() {
                                            $.get("popup-parliament.html", function(htmlResult) {
                                                popup.html(htmlResult)
                                                    .style("visibility", "visible")
                                                    .style("width", "50%")
                                                    .style("height", "50%")
                                                    .style("top", "10px")
                                                    .style("left", "10px");
                                                
                                                d3.select("#parliament-code").text(parliamentResult.parliament_code);
                                                d3.select("#parliament-name").text(parliamentName);
                                                d3.select("#winning-party").text(parliamentResult.winner.party);
                                                d3.select("#winning-candidate").text(parliamentResult.winner.candidate);
                                                d3.select("#total-voter").text(parliamentResult.vote.voter_total);
                                                d3.select("#total-vote-bn").text(parliamentResult.vote.BN);
                                                d3.select("#total-vote-ph").text(parliamentResult.vote.PH);
                                                d3.select("#total-vote-pas").text(parliamentResult.vote.PAS);
                                                d3.select("#total-vote-oth").text(parliamentResult.vote.OTH);
                                            }, "html");
                                        });
                                    }
                                });
                                
                            g.enter().append("text")
                                .attr("class", "state-label")
                                .attr("id", function(d, i) { return setting.state_id[i]; })
                                .style("cursor", "default")
                                .style("pointer-events", "none")
                                .attr("x", function(d, i) {
                                    var bbox = d3.select("#" + setting.state_id[i]).node().getBBox();

                                    switch(setting.state_id[i]) {
                                        case "perlis":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 25);
                                            break;
                                        case "kedah":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 20);
                                            break;
                                        case "pulau-pinang":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 55);
                                            break;
                                        case "perak":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 30);
                                            break;
                                        case "kelantan":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 35);
                                            break;
                                        case "terengganu":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 50);
                                            break;
                                        case "kuala-lumpur":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 80);
                                            break;
                                        case "selangor":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 70);
                                            break;
                                        case "putrajaya":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 70);
                                            break;
                                        case "pahang":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 20);
                                            break;
                                        case "negeri-sembilan":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 100);
                                            break;
                                        case "melaka":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 30);
                                            break;
                                        case "johor":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 20);
                                            break;
                                        case "labuan":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 50);
                                            break;
                                        case "sabah":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 30);
                                            break;
                                        case "sarawak":
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2 - 5);
                                            break;
                                        default:
                                            return ((bbox.x + (bbox.x + bbox.width)) / 2);
                                            break;
                                    }
                                })
                                .attr("y",  function(d, i) {
                                    var bbox = d3.select("#" + setting.state_id[i]).node().getBBox();
                                    
                                    switch(setting.state_id[i]) {
                                        case "perlis":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "pulau-pinang":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "perak":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 15);
                                            break;
                                        case "kuala-lumpur":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 10);
                                            break;
                                        case "selangor":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 - 30);
                                            break;
                                        case "putrajaya":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "pahang":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "negeri-sembilan":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "melaka":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "labuan":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        case "sabah":
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2 + 5);
                                            break;
                                        default:
                                            return ((bbox.y + (bbox.y + bbox.height)) / 2);
                                            break;
                                    }
                                })
                                .text(function(d) { return d.state_name; });
                    });
                });
            });
        </script>
    </body>
</html>
